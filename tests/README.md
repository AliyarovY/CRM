# Тесты CRM API

Полный набор тестов для валидации функциональности CRM API.

## Структура тестов

### Unit тесты (`tests/unit/`)

Тесты для проверки отдельных компонентов:

- **test_permissions.py** - Проверка системы ролей и прав доступа
  - Валидация перечислений ролей
  - Проверка матрицы прав доступа для каждой роли
  - Убедиться, что OWNER имеет все права
  - Убедиться, что VIEWER имеет только READ

- **test_deal_service.py** - Проверка бизнес-логики сделок
  - Создание сделки с положительной суммой
  - Валидация на отрицательные суммы
  - Проверка переходов статусов сделок
  - Валидация попыток выигрыша сделки без суммы

- **test_validators.py** - Проверка Pydantic валидаторов
  - ContactCreate валидация
  - DealCreate и DealStatusChange валидация
  - TaskCreate и TaskStatusChange валидация
  - ActivityCreate валидация

### Интеграционные тесты (`tests/integration/`)

Тесты для проверки взаимодействия компонентов:

- **test_auth.py** - Аутентификация и авторизация
  - Регистрация новых пользователей
  - Проверка на дублирование email/username
  - Вход в систему с верными и неверными учетными данными
  - Обновление токена доступа
  - Смена пароля

- **test_contacts.py** - CRUD операции с контактами
  - Создание контактов
  - Получение списка контактов с пагинацией
  - Получение одного контакта
  - Обновление контакта
  - Удаление контакта
  - Поиск контактов

- **test_deals.py** - CRUD операции и статусы сделок
  - Создание сделок
  - Получение списка сделок с фильтрацией
  - Изменение статуса сделки
  - Проверка валидных и невалидных переходов статусов
  - Проверка на выигрыш сделки без суммы
  - Удаление сделок

- **test_tasks.py** - CRUD операции с задачами
  - Создание задач
  - Получение списка задач
  - Обновление задач
  - Завершение задач
  - Удаление задач
  - Связь задач с контактами и сделками

- **test_analytics.py** - Аналитические эндпоинты
  - Сводка по сделкам (win_rate, pipeline_amount)
  - Сводка по задачам (completion_rate)
  - Статистика контактов
  - Статистика активностей
  - Полная сводка дашборда

- **test_full_scenario.py** - Сквозной тест полного сценария
  - Регистрация пользователя
  - Создание контактов
  - Создание сделок
  - Логирование активностей
  - Создание задач
  - Смена статусов сделок
  - Проверка аналитики

## Запуск тестов

### Все тесты
```bash
pytest
```

### Только unit тесты
```bash
pytest tests/unit/
```

### Только интеграционные тесты
```bash
pytest tests/integration/
```

### Конкретный тест
```bash
pytest tests/unit/test_permissions.py
pytest tests/integration/test_auth.py::TestAuth::test_login_success
```

### С подробным выводом
```bash
pytest -v
```

### С покрытием кода
```bash
pytest --cov=app
```

### Только асинхронные тесты
```bash
pytest -m asyncio
```

## Фикстуры

В `conftest.py` определены следующие фикстуры:

- **test_db** - Тестовая база данных (SQLite в памяти)
- **client** - AsyncClient для тестирования API
- **test_organization** - Тестовая организация
- **test_user** - Тестовый пользователь (OWNER роль)
- **test_user_token** - JWT токены для тестового пользователя
- **test_user_sales** - Тестовый пользователь (SALES роль)
- **test_user_sales_token** - JWT токены для SALES пользователя
- **auth_headers** - Заголовки для авторизации OWNER
- **sales_auth_headers** - Заголовки для авторизации SALES

## Зависимости для тестирования

```
pytest>=7.0.0
pytest-asyncio>=0.20.0
httpx>=0.24.0
aiosqlite>=0.17.0
email-validator>=2.0.0
```

## Конфигурация

Файл `pytest.ini` содержит конфигурацию pytest:
- asyncio_mode = auto (автоматическое обнаружение async тестов)
- testpaths = tests (поиск тестов в папке tests)
- Настройка именования файлов и классов

## Лучшие практики

1. Каждый тест должен быть независимым
2. Использовать фикстуры для настройки данных
3. Названия тестов должны описывать что они проверяют
4. Использовать assert для проверки результатов
5. Тесты должны проверять как успешные, так и неуспешные сценарии
