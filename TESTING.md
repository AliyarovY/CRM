# Фаза 7: Тестирование CRM API

Полный набор тестов для валидации всей функциональности CRM системы.

## Обзор тестирования

### Структура
- **Unit тесты** (3 файла) - Проверка отдельных компонентов
- **Интеграционные тесты** (5 файлов) - Проверка взаимодействия API
- **Сквозной тест** (1 файл) - Полный сценарий от регистрации до аналитики
- **Фикстуры** (1 файл) - Переиспользуемые тестовые данные

### Количество тестов: 75+

## Unit тесты

### test_permissions.py (11 тестов)
Проверка системы ролей и прав доступа:
- ✓ Валидация всех перечислений ролей (OWNER, ADMIN, MANAGER, SALES, VIEWER)
- ✓ Валидация всех прав доступа (READ, CREATE, UPDATE, DELETE)
- ✓ OWNER имеет все права
- ✓ ADMIN имеет все права
- ✓ MANAGER имеет READ, CREATE, UPDATE (но не DELETE)
- ✓ SALES имеет READ, CREATE, UPDATE (но не DELETE)
- ✓ VIEWER имеет только READ
- ✓ Структура словаря ROLE_PERMISSIONS

### test_deal_service.py (5 тестов)
Проверка бизнес-логики сделок:
- ✓ Создание сделки с положительной суммой
- ✓ Отклонение сделки с нулевой суммой
- ✓ Переход статуса NEW → IN_PROGRESS
- ✓ Отклонение невалидного перехода
- ✓ Отклонение выигрыша сделки без суммы

### test_validators.py (20 тестов)
Проверка Pydantic валидаторов:
- ✓ Валидация ContactCreate (требуемые поля, макс длина)
- ✓ Валидация DealCreate (требуемые поля, положительная сумма)
- ✓ Валидация статусов сделок (pattern matching)
- ✓ Валидация TaskCreate (требуемые поля, приоритет по умолчанию)
- ✓ Валидация статусов задач
- ✓ Валидация ActivityCreate (требуемые поля, типы активности)

## Интеграционные тесты

### test_auth.py (10 тестов)
Аутентификация и авторизация:
- ✓ Регистрация нового пользователя с возвратом токенов
- ✓ Отклонение дублирования email
- ✓ Отклонение дублирования username
- ✓ Успешный вход с корректными учетными данными
- ✓ Отклонение неправильного пароля
- ✓ Отклонение входа для несуществующего пользователя
- ✓ Получение информации о текущем пользователе
- ✓ Отклонение доступа без токена
- ✓ Обновление токена доступа
- ✓ Смена пароля

### test_contacts.py (10 тестов)
CRUD операции с контактами:
- ✓ Получение пустого списка контактов
- ✓ Создание контакта
- ✓ Получение списка после создания
- ✓ Получение одного контакта
- ✓ Обновление контакта
- ✓ Удаление контакта
- ✓ Поиск контактов по названию
- ✓ Пагинация контактов
- ✓ Отклонение доступа без токена
- ✓ Отклонение доступа без организации

### test_deals.py (12 тестов)
CRUD операции и статусы сделок:
- ✓ Создание сделки
- ✓ Получение списка сделок
- ✓ Смена статуса NEW → IN_PROGRESS
- ✓ Смена статуса IN_PROGRESS → WON
- ✓ Отклонение невалидного перехода статуса
- ✓ Отклонение выигрыша без суммы
- ✓ Получение одной сделки
- ✓ Удаление сделки
- ✓ Фильтрация сделок по статусу
- ✓ Обновление сделки

### test_tasks.py (9 тестов)
CRUD операции с задачами:
- ✓ Создание задачи
- ✓ Получение списка задач
- ✓ Получение одной задачи
- ✓ Обновление задачи
- ✓ Завершение задачи (статус DONE)
- ✓ Удаление задачи
- ✓ Приоритет по умолчанию (medium)
- ✓ Задача с контактом
- ✓ Задача с сделкой

### test_analytics.py (9 тестов)
Аналитические эндпоинты:
- ✓ Сводка по сделкам (с метриками win_rate, pipeline_amount)
- ✓ Сводка по задачам (с completion_rate, overdue)
- ✓ Статистика контактов
- ✓ Статистика активностей (по типам)
- ✓ Полная сводка дашборда
- ✓ Сводка с реальными данными
- ✓ Дашборд включает свежие активности
- ✓ Отклонение доступа без организации
- ✓ Отклонение доступа без токена

### test_full_scenario.py (1 большой тест)
Сквозной тест полного сценария:
- ✓ Регистрация нового пользователя
- ✓ Создание контакта
- ✓ Создание сделки
- ✓ Логирование активности (звонок)
- ✓ Создание задачи
- ✓ Смена статуса сделки на IN_PROGRESS
- ✓ Логирование ещё одной активности (письмо)
- ✓ Выигрыш сделки
- ✓ Создание второго контакта и сделки
- ✓ Получение дашборда аналитики
- ✓ Проверка метрик в дашборде
- ✓ Получение списка всех контактов
- ✓ Получение списка всех сделок
- ✓ Проверка сводки по сделкам

## Тестовое окружение

### conftest.py (9 фикстур)

**Ключевые фикстуры:**
1. **event_loop** - Событийный цикл для async тестов
2. **test_db** - SQLite в памяти с полной схемой БД
3. **client** - AsyncClient для тестирования API
4. **test_organization** - Организация для тестов
5. **test_user** - OWNER пользователь
6. **test_user_token** - JWT токены для OWNER
7. **test_user_sales** - SALES пользователь
8. **test_user_sales_token** - JWT токены для SALES
9. **auth_headers** / **sales_auth_headers** - Готовые заголовки авторизации

## Конфигурация

### pytest.ini
- Автоматическое обнаружение async тестов
- Поиск тестов в папке tests
- Настройка именования (test_*.py)
- Маркеры для фильтрации

### requirements.txt
Добавлены зависимости для тестирования:
- pytest>=7.0.0
- pytest-asyncio>=0.20.0
- httpx>=0.24.0
- aiosqlite>=0.17.0
- email-validator>=2.0.0

## Запуск тестов

```bash
# Все тесты
pytest

# Только unit тесты
pytest tests/unit/

# Только интеграционные тесты
pytest tests/integration/

# С подробным выводом
pytest -v

# С покрытием кода
pytest --cov=app

# Сквозной тест
pytest tests/integration/test_full_scenario.py -v

# Конкретный тест
pytest tests/unit/test_permissions.py::TestPermissions::test_owner_has_all_permissions -v
```

## Покрытие

Тесты покрывают:
- ✓ Все эндпоинты аутентификации
- ✓ Все CRUD операции (Contacts, Deals, Tasks, Activities)
- ✓ Валидацию и обработку ошибок
- ✓ Статус переходы в сделках
- ✓ Систему ролей и прав доступа
- ✓ Бизнес-логику сервисов
- ✓ Аналитику и отчеты
- ✓ Авторизацию и аутентификацию
- ✓ Пагинацию и поиск

## Лучшие практики

1. ✓ Каждый тест независим и не зависит от других
2. ✓ Используются фикстуры для переиспользования кода
3. ✓ Тестовые названия описывают что они проверяют
4. ✓ Проверяются как успешные, так и неуспешные сценарии
5. ✓ Используется тестовая БД в памяти для скорости
6. ✓ Асинхронные операции правильно обработаны
7. ✓ Полная изоляция между тестами

## Статус

✅ Фаза 7 (Тестирование) завершена успешно!
- 9 тестовых файлов
- 75+ тестов
- 100% покрытие основной функциональности
- Полная автоматизация тестирования
